source "$(dirname "$(dirname "${BASH_SOURCE[0]}")")/lib/stage_handler_dispatcher.rc"
source "$(dirname "$(dirname "${BASH_SOURCE[0]}")")/lib/docker.rc"

function execute_stage() {
  local _target="${1:-"source"}" _filter="${2:-.*}"
  shift 2
  message "BEGIN HANDLER(test): target: '${_target}'; filter: '${_filter}': '${*}'"
  buildtools__execute_stage "${_target}" "${_filter}" "${@}"
  __check_testreport_json_file "${TESTREPORTDIR}/testreport.json"
  message "END HANDLER(test)"
}

function __run_commandunit() {
  local _test_filter="${1}"
  shift
  run_commandunit \
    --parallel \
    --tap \
    --filter="${_test_filter}" \
    --configdir="${TESTDIR}/.commandunit" \
    --test-report="${TESTREPORTDIR}" \
    --test-srcdir="${TESTDIR}" \
    --test-workdir="${TESTDIR}"
}

# source
function handle_source() {
  _docker_prefix=""
  export COMMANDUNIT_DOCKERDIR_PREFIX="${_docker_prefix}"
  function run_commandunit() {
    run_command_unit_with_source "${@}"
  }
  __run_commandunit "${@}"
}

# snapshot
function handle_snapshot() {
  _docker_prefix="/var/lib/commandunit"
  export COMMANDUNIT_DOCKERDIR_PREFIX="${_docker_prefix}"
  message "COMMANDUNIT_DOCKERDIR_PREFIX: '${COMMANDUNIT_DOCKERDIR_PREFIX}'"
  function run_commandunit() {
    run_command_unit_with_snapshot_docker_image "${@}"
  }
  __run_commandunit "${@}"
}

# release
function handle_release() {
  _docker_prefix="/var/lib/commandunit"
  export COMMANDUNIT_DOCKERDIR_PREFIX="${_docker_prefix}"
  function run_commandunit() {
    run_command_unit_with_released_docker_image "${@}"
  }
  __run_commandunit "${@}"
}

function __check_testreport_json_file() {
  local _testreport_json_file="${1}"
  local _was_successful
  _was_successful="$(jq '.wasSuccessful' "${_testreport_json_file}")"
  if [[ "${_was_successful}" == true ]]; then
    return 0
  elif [[ "${_was_successful}" ]]; then
    abort "One or more tests have failed. Check test report files found under $(dirname "${_testreport_json_file}")."
  fi
  abort "Some error was detected test execution or report generation."
}
